<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tales of Aradia: Idle RPG</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', sans-serif; background: #121212; color: #ddd; }
    .container {display: flex;min-height: 100vh;height: 100vh;width: 100vw;overflow: hidden;}

    /* Loading screen */
    body.login-screen {background: url("images/bg-login.png") no-repeat center center fixed;background-size: cover;}
    #login-panel {position: absolute;top: 50%; left: 50%;transform: translate(-50%, -50%);background: rgba(31,31,31,0.85);padding: 20px;border-radius: 6px;width: auto;box-shadow: 0 0 10px rgba(0,0,0,0.7);}
    #login-panel img {margin: auto;display: block;max-width: 450px;}
    #login-panel h1 { color: #fff; text-align: center; margin-bottom: 12px; }
    #login-panel input {width: 100%; padding: 10px; margin: 6px 0;border: none; border-radius: 4px;}
    #login-panel .controls {display: flex; gap: 8px; margin: 12px 0;}
    #login-panel .controls button {flex: 1; padding: 10px; border: none;border-radius: 4px; background: #3a7bd5; color: #fff;cursor: pointer;}
    #login-msg { color: #f88; text-align: center; margin-top: 6px;}
    #loading-screen {display: none;position: absolute; top: 0; left: 0;width: 100%; height: 100%;background: rgba(0,0,0,0.8);color: #fff; font-size: 1.2rem;display: flex; align-items: center; justify-content: center;flex-direction: column;z-index: 9;}
    #loading-screen .spinner { display: none !important; }
    
    /* Sidebar */
    .sidebar {width: 300px;min-width: 220px;max-width: 350px;background: #1f1f1f;border-right: 1px solid #333;padding: 20px 0 20px 0;display: flex;flex-direction: column;align-items: center;height: 100vh;box-sizing: border-box;overflow-y: auto;overflow-x: hidden;}
    .sidebar h2 { color: #ccc; text-align: center; margin-bottom: 10px; }
    .profile { width: 90%; margin-bottom: 16px; }
    .profile-pic { width: 64px; height: 64px; border-radius: 100px; margin: 0 auto 8px auto; display: block;}
    .profile-name, .profile-id, .last-active, .gold-balance { text-align: center; font-size: 0.95em; color: #ddd; margin-bottom: 2px;}
    .skill-list { list-style: none; width: 90%; }
    .skill-list li { display: flex; align-items: center; padding: 10px; cursor: pointer; transition: background .2s; border-radius: 4px;}
    .skill-list li.active, .skill-list li:hover { background: #2a2a2a; }
    .skill-list img { width: 32px; height: 32px; margin-right: 8px; }
    #inventory, #equipment, #shop { width: 90%; margin: 0 auto 20px auto; }
    #inventory h3, #equipment h3, #shop h3 { color: #ccc; font-size: 1rem; border-bottom: 1px solid #444; padding-bottom: 4px; margin-bottom: 8px; }
    .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; width: 100%; }
    .inv-card { background: #232323; border-radius: 4px; box-shadow: 0 2px 6px #000a; padding: 8px; display: flex; flex-direction: column; align-items: center; font-size: .82rem; text-align:center;}
    .inv-card img { width: 32px; height: 32px; object-fit: contain; margin-bottom: 2px; filter: drop-shadow(0 1px 2px #0007); }
    .leader-list { list-style: none; padding-left: 0; }
    .leader-list li { padding: 6px 0; border-bottom: 1px solid #333; color: #ddd; font-size: .9rem; }
    #shop h3 { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
    #shop h3 .arrow { transition: transform 0.2s ease; }
    #shop.collapsed #shop-grid, #shop.collapsed .inv-grid { display: none !important}
    #shop.collapsed h3 .arrow { transform: rotate(-90deg); }
    #shop h4 { color: #ccc; font-size: 1rem; margin: 12px auto; padding-bottom: 4px; border-bottom: 1px solid #444; text-align: center;}
    .shop-filters { display: flex; justify-content: center; gap: 8px; margin: 8px 0; }
    .shop-filters button { padding: 4px 8px; border: none; border-radius: 4px; background: #2a2a2a; color: #fff; cursor: pointer; font-size: .85rem; white-space:nowrap;}
    .shop-filters button.active { background: #3a7bd5; }
    .equipment-panel {
      display: grid; grid-template-columns: repeat(3, 1fr);
      grid-template-areas:
        "ammo head cape"
        "weapon body shield"
        "ring legs ring2"
        ".    boots    .";
      grid-gap: 12px;background: #3a3a3a url('chain-bg.png') center/cover no-repeat;padding: 8px; border: 2px solid #000;border-radius: 4px; width: 100%; box-sizing: border-box;margin-bottom: 16px;justify-items:center;}
    .slot { position: relative; width: 40px; height: 40px; background: #2e2e2e url('slot-bg.png') center/contain no-repeat; border: 2px solid #000; box-shadow: inset 0 0 4px #000; }
    .slot img { width: 100%; height: 100%; object-fit: contain; }
    .slot-label { position: absolute; bottom: -14px; width: 100%; text-align: center; font-size: 0.65rem; color: #aaa; }
    .ammo { grid-area: ammo; } .head { grid-area: head; } .cape { grid-area: cape; }
    .weapon { grid-area: weapon; } .body { grid-area: body; } .shield { grid-area: shield; }
    .ring { grid-area: ring; } .legs { grid-area: legs; } .ring2 { grid-area: ring2; } .boots { grid-area: boots; }

    /* Main APP */
    .main {flex: 1 1 0;min-width: 0;overflow-x: auto;display: flex;flex-direction: column;padding: 20px;}
    .main-header { display: flex; flex-wrap:wrap; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 12px; }
    .main-header h1 { font-size: 1.5rem; color: #fff; }
    .stats { font-size: .9rem; color: #ffffff; display: flex; gap: 12px; align-items: center; flex-wrap:wrap;}
    .stats .hp { color: #f66; }
    #stop-btn, #resume-btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; background: #d9534f; color: #fff; font-size: .85rem; }
    #resume-btn { background: #5cb85c; }
    #progress-container { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
    #progress-bar { width: 0%; height: 100%; background: #4caf50; transition: width 0s; }
    #progress-text { text-align: center; color: #aaa; margin-bottom: 16px; height: 1.2em; }
    .tree-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 16px; flex: 1; overflow-y: auto; min-height:120px;}
    .tree-card { position: relative; background: #1e1e1e; border: 1px solid #333; border-radius: 4px; display: flex; flex-direction: column; align-items: center; padding-bottom: 8px; transition: transform .2s, border-color .2s; }
    .tree-card:hover { transform: translateY(-4px); border-color: #555; }
    .tree-card img { height: 120px; width: auto; max-width: 100%; object-fit: contain; background: #1e1e1e; margin-top: 8px; }
    .label { padding: 8px; background: #2a2a2a; color: #fff; text-align: center; font-size: .9rem; width: 100%; }
    .tree-card button { margin: 8px; padding: 8px; width: 80%; border: none; background: #3a7bd5; color: #fff; cursor: pointer; font-size: .9rem; border-radius: 3px; }
    .tree-card button:disabled { background: #555; cursor: not-allowed; }
    .lock { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; color: #f66; font-size: 1.1rem; }
    .health-bar { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 4px; }
    .health-bar-inner { height: 100%; background: #f44336; width: 100%; transition: width .3s; }
    .tree-card {border-color: #b79f1c;box-shadow: 0 0 8px #b79f1c;}
    .tree-card:hover {transform: translateY(-4px);border-color: #b79f1c;box-shadow: 0 0 12px #b79f1c, 0 2px 6px rgba(0,0,0,0.6);}
    .tree-card.active {border-color: #30d549;box-shadow: 0 0 8px #30d549;}
    #firemaking-header img {animation: campfire-flicker 0.8s infinite alternate;}

    /* Fishing */
    .item-card {position: relative;background: #232323;border-radius: 4px;box-shadow: 0 2px 6px #000a;padding: 8px;display: flex;flex-direction: column;align-items: center;font-size: .82rem;text-align: center;}
    #fish-grid {display: grid;grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));gap: 12px;margin-top: 12px;}
    .progress-container {width: 100%;height: 8px;background: #333;border-radius: 4px;overflow: hidden;margin-top: 12px;}
    #fish-progress-bar {width: 0;height: 100%;background: #4caf50;transition: width 0.3s;}
    #fishing-panel .item-card img {width: 48px;height: 48px;object-fit: contain;margin-bottom: 8px;}
    #fishing-panel .controls > button {padding: 6px 12px;border: none;border-radius: 4px;cursor: pointer;background: #3a7bd5;color: #fff;font-size: .85rem;margin-right: 8px;}
        @keyframes campfire-flicker {
          0%   { filter: drop-shadow(0 4px 18px #ffb32099);}
          100% { filter: drop-shadow(0 10px 28px #ff940055);}}

    /* ----- Mobile (TEST) ------*/
    #sidebar-toggle {display: none;position: fixed;top: 16px;left: 16px;z-index: 1100;background: #3a7bd5;border-radius: 4px;padding: 8px 12px;color: #fff;font-size: 1.4rem;cursor: pointer;user-select: none;}

      /* Overlay for when sidebar is open */
    #sidebar-overlay {display: none;position: fixed;top: 0; left: 0;width: 100vw; height: 100vh;background: rgba(0,0,0,0.5);z-index: 1050;cursor: pointer;}

      /* Mobile sidebar default offscreen */
    .sidebar {position: fixed;top: 0;left: 0;height: 100vh;width: 280px;max-width: 80vw;background: #1f1f1f;border-right: 1px solid #333;padding: 20px 10px;box-sizing: border-box;overflow-y: auto;transform: translateX(-100%);transition: transform 0.3s ease;z-index: 1100;}

      /* When checkbox is checked (sidebar open) */
    #sidebar-toggle-checkbox:checked ~ .sidebar {transform: translateX(0);}

    #sidebar-toggle-checkbox:checked ~ #sidebar-overlay {
      display: block;
    }

    /* Show hamburger button only on mobile */
    @media (max-width: 768px) {
      #sidebar-toggle {display: block;}

      /* When sidebar open, disable page scroll if you want */
      #sidebar-toggle-checkbox:checked ~ #sidebar-overlay {overflow: hidden;}

      /* Make your main content full width on mobile */
      .container {flex-direction: column;height: auto;min-height: 100vh;overflow-x: hidden;}

      .main {width: 100%;padding: 20px 10px;}}

    /* Hide sidebar and toggle on larger screens */
    @media (min-width: 769px) {
      #sidebar-toggle,
      #sidebar-overlay {display: none !important;}
      .sidebar {position: relative;transform: translateX(0) !important;width: 300px;height: 100vh;}}
    
    /* ----- End - Mobile (TEST) ------*/
</style>
</head>
<body>
<body class="login-screen">
  <audio id="chop-sound" src="sounds/chop.wav" preload="auto"></audio>

  <!-- LOGIN -->
  <div id="login-panel">
    <img src="images/login_logo.png">
    <input id="username" placeholder="Username"/>
    <input id="password" type="password" placeholder="Password"/>
    <div class="controls">
      <button id="login-btn">Login</button>
      <button id="reg-btn">Register</button>
    </div>
    <p id="login-msg"></p>
  </div>

  <div id="notif-bar" style="display:none;position:fixed;top:24px;left:50%;transform:translateX(-50%);background:rgba(60,60,60,0.95);color:#fff;padding:10px 28px;border-radius:8px;font-size:1.1rem;box-shadow:0 2px 10px #0008;z-index:99;pointer-events:none;transition: opacity .2s;"></div>
 
  <!-- APP -->
  <div class="container" id="app" style="display:none;">
    <nav class="sidebar">
      <h2>Welcome Traveler!</h2>
      <div class="profile">
        <img src="images/profile.png" alt="Profile Picture" class="profile-pic"/>
        <div class="profile-name">—</div>
        <div class="profile-id">PlayFab ID: <span id="playfab-id">—</span></div>
        <div class="last-active">Last Active: <span id="last-active">—</span></div>
        <div class="gold-balance">Gold: <span id="gold-count">0</span></div>
      </div>
      <h2>Skills</h2>
        <ul class="skill-list">
          <li class="active" data-skill="woodcutting">
            <img src="icons/woodcutting/Lumbering.png"/><span>Woodcutting</span>
          </li>
          <li data-skill="firemaking">
            <img src="icons/firemaking/Firemaking.png"/><span>Firemaking</span>
          </li>
          <li data-skill="fishing">
            <img src="icons/fishing/Fish_Shrimp.png"/><span>Fishing</span>
          </li>
          <li data-skill="cooking">
            <img src="icons/cooking/Cooking.png"/><span>Cooking</span>
          </li>
          <li data-skill="Mining">
            <img src="icons/mining/Mining.png"/><span>Mining</span>
          </li>
          <li data-skill="smithing">
            <img src="icons/smithing/Smithing.png"/><span>Smithing</span>
          </li>
          <li data-skill="Fletching">
            <img src="icons/fletching/Fletching.png"/><span>Fletching</span>
          </li>
        </ul>

      <h3>Equipment</h3>
      <div class="equipment-panel">
        <div class="slot head"><div class="slot-label">Helm</div></div>
        <div class="slot cape"><div class="slot-label">Cape</div></div>
        <div class="slot neck"><div class="slot-label">Neck</div></div>
        <div class="slot weapon"><div class="slot-label">Weapon</div></div>
        <div class="slot body"><div class="slot-label">Body</div></div>
        <div class="slot shield"><div class="slot-label">Shield</div></div>
        <div class="slot legs"><div class="slot-label">Legs</div></div>
        <div class="slot boots"><div class="slot-label">Boots</div></div>
        <div class="slot ring"><div class="slot-label">Ring</div></div>
        <div class="slot ring2"><div class="slot-label">Ring</div></div>
      </div>

      <div id="inventory">
        <h3>Inventory</h3>
        <div id="inventory-grid" class="inv-grid"></div>
      </div>
      <div id="shop">
        <h3>Shop <span class="arrow">▼</span></h3>
        <div class="shop-filters">
          <button data-filter="all" class="active">All</button>
          <button data-filter="sell">Sell</button>
          <button data-filter="buy">Buy</button>
        </div>
        <div class="shop-list">
          <h4 id="buy-header">Buy Items</h4>
          <div id="shop-grid" class="inv-grid"></div>
          <div id="buy-grid" class="inv-grid"></div>
        </div>
      </div>
      
    </nav>

    <!-- MAIN CONTENT -->
    <section class="main">
      <!-- Woodcutting header -->
      <div id="woodcutting-header" class="main-header">
        <h1>Woodcutting</h1>
        <div class="stats">
          Level <span id="wc-level">1</span> |
          Wood <span id="wood-count">0</span> |
          XP <span id="wc-xp">0</span>/<span id="wc-next">0</span> |
          Gold <span id="gold-count">0</span> |
          <span class="hp">HP <span id="player-hp">100</span>/<span id="player-maxhp">100</span></span>
          <button id="stop-btn">Stop</button>
          <button id="resume-btn">Resume</button>
        </div>
      </div>

      <!-- Firemaking header -->
      <div id="firemaking-header" style="display:none; flex-direction:column; align-items:center; gap:20px;">
        <h1>Firemaking</h1>
        <div style="display:flex; gap:30px; justify-content:center; align-items:center; flex-wrap:wrap;">
          <!-- Stats Panel -->
          <div id="firemaking-stats" style="background:#232323; border-radius:8px; padding:18px 24px; box-shadow:0 2px 8px #0005; min-width:210px;">
            <div>Level <span id="fm-level">1</span></div>
            <div>Fires <span id="fire-count">0</span></div>
            <div>XP <span id="fm-xp">0</span>/<span id="fm-next">0</span></div>
            <div>Gold <span id="gold-count-fm">0</span></div>
          </div>

          <!-- Fire Image + Dropdown -->
          <div style="display:flex; flex-direction:column; align-items:center;">
            <img src="campfire.png" alt="Campfire" style="width:170px; height:auto; margin-bottom:18px; filter:drop-shadow(0 6px 24px #ffb32080);">
            <select id="firemaking-log-select" style="font-size:1rem; padding:7px 16px; border-radius:5px; border:none; background:#232323; color:#fff; margin-bottom:12px; box-shadow:0 1px 3px #0008;">
            </select>
            <button id="light-fire-btn" style="font-size:1.1rem; padding:8px 38px; border-radius:5px; border:none; background:#e25822; color:#fff; cursor:pointer; font-weight:bold; box-shadow:0 2px 8px #0005;">Light Fire</button>
            <div id="fm-progress-container" style="width:180px; height:8px; background:#444; border-radius:4px; margin-top:12px; overflow:hidden; display:none;">
              <div id="fm-progress-bar" style="width:0%; height:100%; background:#ffa600; transition:width .2s;"></div>
            </div>
            <div id="fm-progress-text" style="color:#ccc; margin-top:8px; min-height:20px;"></div>
          </div>
        </div>
      </div>

        <!-- Fishing -->
      <div id="fishing-panel" class="panel" style="display:none;">
        <h1>Fishing</h1>
        <div class="stats">
          Level: <span id="fish-level">1</span> |
          Count: <span id="fish-count">0</span> |
          XP: <span id="fish-xp">0</span>/<span id="fish-next">4</span>
        </div>
        <div class="progress-container">
          <div id="fish-progress-bar"></div>
          <div id="fish-progress-text"></div>
        </div>
        <div id="fish-grid"></div>
        <div class="controls">
          <button id="fish-start">Start Fishing</button>
          <button id="fish-stop">Stop Fishing</button>
        </div>
      </div>

      <!-- Only ONE progress bar and tree grid -->
      <div id="progress-container"><div id="progress-bar"></div></div>
      <div id="progress-text"></div>
      <div id="tree-grid" class="tree-grid"></div>
    </section>
  </div>
  </div>

  <script>
    // — LOGIN HANDLER (with background removal) —
    async function auth(isLogin) {
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      let payload = { Username: u, Password: p };
      if (!isLogin) {
        payload.DisplayName = u;
        payload.RequireBothUsernameAndEmail = false;
        payload.Email = `${u}@example.com`;
      }
      try {
        let r = await playfabCall(
          isLogin ? 'LoginWithPlayFab' : 'RegisterPlayFabUser',
          payload
        );
        sessionTicket = r.SessionTicket;
        playFabId     = r.PlayFabId;
        document.getElementById('login-panel').style.display = 'none';
        document.getElementById('app').style.display         = '';
        document.body.classList.remove('login-screen');
        initGame();
      } catch (e) {
        document.getElementById('login-msg').textContent = e.errorMessage || JSON.stringify(e);
      }
    }
    document.getElementById('login-btn').onclick = () => auth(true);
    document.getElementById('reg-btn').onclick   = () => auth(false);

    // — CONFIG & STATE —
    let TITLE_ID = "1C6B29", MAX_LEVEL = 99, XP_TABLE = [];
    (function(){
      let cum = 0;
      for (let lvl = 1; lvl <= MAX_LEVEL; lvl++) {
        cum += Math.floor(lvl + 300 * Math.pow(2, lvl/7));
        XP_TABLE[lvl] = Math.floor(cum/4);
      }
    })();
    function nextXpFor(l) { return l < MAX_LEVEL ? XP_TABLE[l+1] - XP_TABLE[l] : Infinity; }

    function showNotif(msg, duration=1500) {
      let bar = document.getElementById('notif-bar');
      bar.textContent = msg;
      bar.style.display = 'block';
      bar.style.opacity = 1;
      setTimeout(() => {
        bar.style.opacity = 0;
        setTimeout(() => { bar.style.display = 'none'; }, 350);
      }, duration);
    }

    // prices for selling
    let PRICES = {
        1:"Logs", 
        2:"Birch Logs", 
        5:"Oak Logs", 
        8:"Willow Logs", 
        12:"Sakura Logs",
        20:"Japanese Maple Logs", 
        25:"Sycamore Maple Logs",
        30:"Gigantic Oak Logs", 
        35:"Palm Logs",
        40:"Pitch Pine Logs", 
        45:"Eastern Redwood Logs",
        200:"Bird Nests"
    };

    // items you can buy
    let BUYABLES = [
      { cost:50,  name:"Iron Axe",          slot:"weapon", img: "icons/woodcutting/Iron_Axe.png" },
      { cost:100, name:"Steel Axe",         slot:"weapon", img: "icons/woodcutting/Steel_Axe.png" },
      { cost:150, name:"Woodcutting Hood",  slot:"head",   img: "icons/woodcutting/Woodcutting_Hood.png" },
      { cost:150, name:"Woodcutting Top",   slot:"body",   img: "icons/woodcutting/Woodcutting_Top.png" },
      { cost:150, name:"Woodcutting Legs",  slot:"legs",   img: "icons/woodcutting/Woodcutting_Legs.png" },
      { cost:150, name:"Woodcutting Boots", slot:"boots",  img: "icons/woodcutting/Woodcutting_Boots.png" },
      { cost:150, name:"Amulet of Nature",  slot:"neck",   img: "icons/woodcutting/Amulet_of_Nature.png" },
      { cost:150, name:"Woodcutting Gloves",slot:"ring",   img: "icons/woodcutting/Woodcutting_Gloves.png" }
    ];

    let sessionTicket, playFabId;
    let timer, nextTick, interval;
    let autoEnabled = true;

    let state = {
      level:1, xp:0, wood:0, gold:0,
      health:100, maxHealth:100,
      inventory:{},
      equipment: {
        head:   null,
        cape:   null,
        neck:   null,
        weapon: null,
        body:   null,
        shield: null,
        legs:   null,
        boots:  null,
        ring:   null,
        ring2:  null
      },
      inCombat:false, monsterHP:0, monsterMaxHP:0,
      lastActive:Date.now()
    };

    const ICON_PATH = "icons/woodcutting/";
    let TREES = [
      {id:1,  lvl:1,  xp:25,    name:'Tree',              itemKey:'Logs',                 img:ICON_PATH+'Tree_Level1.png'},
      {id:2,  lvl:10, xp:37.5,  name:'Oak',               itemKey:'Oak Logs',             img:ICON_PATH+'Tree_Oak.png'},
      {id:3,  lvl:20, xp:50,    name:'Birch',             itemKey:'Birch Logs',           img:ICON_PATH+'Tree_Birch.png'},
      {id:4,  lvl:30, xp:67.5,  name:'Willow',            itemKey:'Willow Logs',          img:ICON_PATH+'Tree_Willow.png'},
      {id:5,  lvl:40, xp:80,    name:'Sakura',            itemKey:'Sakura Logs',          img:ICON_PATH+'Tree_Sakura.png'},
      {id:6,  lvl:50, xp:100,   name:'Japanese Maple',    itemKey:'Japanese Maple Logs',  img:ICON_PATH+'Tree_Japanese_Maple.png'},
      {id:7,  lvl:60, xp:175,   name:'Sycamore Maple',    itemKey:'Sycamore Maple Logs',  img:ICON_PATH+'Tree_Maple.png'},
      {id:8,  lvl:70, xp:200,   name:'Gigantic Oak',      itemKey:'Gigantic Oak Logs',    img:ICON_PATH+'Tree_Gigantic_Oak.png'},
      {id:9,  lvl:80, xp:250,   name:'Palm',              itemKey:'Palm Logs',            img:ICON_PATH+'Tree_Palm.png'},
      {id:10, lvl:90, xp:380,   name:'Pitch Pine',        itemKey:'Pitch Pine Logs',      img:ICON_PATH+'Tree_Pine.png'},
      {id:11, lvl:95, xp:420,   name:'Eastern Redwood',   itemKey:'Eastern Redwood Logs', img:ICON_PATH+'Tree_Gigantic.png'},
      {id:12, lvl:99, xp:480,   name:'Aradias Legendary', itemKey:'Bird Nests',           img:ICON_PATH+'Tree_Legendary.png'}
    ];
    window.TREES = TREES;

    state.firemaking = { level:1, xp:0, fires:0 };
    // — PLAYFAB HELPER & AUTH —
    async function playfabCall(ep, payload){
      let headers = {'Content-Type':'application/json','X-ReportErrorAsSuccess':'true'};
      if(sessionTicket) headers['X-Authentication'] = sessionTicket;
      let res = await fetch(`https://${TITLE_ID}.playfabapi.com/Client/${ep}`, {
        method:'POST', headers, body: JSON.stringify({ TitleId: TITLE_ID, ...payload })
      });
      let js = await res.json();
      if(js.error) throw js.error;
      return js.data;
    }

    async function auth(isLogin){
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      let body = { Username:u, Password:p };
      if(!isLogin){
        body.DisplayName = u;
        body.RequireBothUsernameAndEmail = false;
        body.Email = `${u}@example.com`;
      }
      try {
        let r = await playfabCall(isLogin?'LoginWithPlayFab':'RegisterPlayFabUser', body);
        sessionTicket = r.SessionTicket;
        playFabId = r.PlayFabId;
        document.getElementById('login-panel').style.display = 'none';
        document.getElementById('app').style.display = '';
        initGame();
      } catch(e) {
        document.getElementById('login-msg').textContent = e.errorMessage || JSON.stringify(e);
      }
    }
    document.getElementById('login-btn').onclick = ()=>auth(true);
    document.getElementById('reg-btn').onclick   = ()=>auth(false);

    // — LOAD / SAVE STATE —
    async function saveState(){
      state.lastActive = Date.now();
      try {
        await playfabCall('UpdateUserData', { Data:{ state: JSON.stringify(state) }});
        await playfabCall('UpdatePlayerStatistics', { Statistics:[{ StatisticName:'WoodcuttingScore', Value: state.wood }]});
      } catch{}
      await refreshLeaderboard();
    }

    async function loadState(){
      try {
        let r = await playfabCall('GetUserData',{ Keys:['state'] });
        if(r.Data.state?.Value) Object.assign(state, JSON.parse(r.Data.state.Value));
      } catch{}
      state.gold = state.gold || 0;
      state.equipment = state.equipment || { weapon:null, gloves:null };
    }

    // — RENDERING —
    function renderInventory(){
      let grid = document.getElementById('inventory-grid'); grid.innerHTML = '';
      for(let [name,qty] of Object.entries(state.inventory)){
        if(qty>0){
          let card = document.createElement('div'); card.className = 'inv-card';
          card.innerHTML = `
            <img src="${ICON_PATH}${name.replace(/ /g,'_')}.png" onerror="this.style.opacity=.25">
            <div class="qty">×${qty}</div>
            <div class="iname">${name}</div>
          `;
          grid.appendChild(card);
        }
      }
    }

    function renderShop(){
      let grid = document.getElementById('shop-grid'); grid.innerHTML = '';
      for(let [price,item] of Object.entries(PRICES)){
        let qty = state.inventory[item]||0;
        let card = document.createElement('div'); card.className='inv-card';
        card.innerHTML = `
          <div class="iname">${item}</div>
          <div class="qty">You have: ${qty}</div>
          <div class="qty">Price: ${price} gold</div>
          <button ${qty===0?'disabled':''}>Sell 1</button>
        `;
        card.querySelector('button').onclick = async ()=>{
          state.inventory[item]--; state.gold+=price;
          await saveState();
          document.getElementById('gold-count').textContent = state.gold;
          renderInventory(); renderShop();
        };
        grid.appendChild(card);
      }
    }

    function renderBuy(){
      let grid = document.getElementById('buy-grid'); grid.innerHTML = '';
      BUYABLES.forEach(i=>{
        let owned = state.equipment[i.slot]===i.name;
        let aff   = state.gold>=i.cost;
        let card = document.createElement('div'); card.className='inv-card';
        card.innerHTML=`
          <img src="${i.img}" onerror="this.style.opacity=.5">
          <div class="iname">${i.name}</div>
          <div class="qty">Cost: ${i.cost} gold</div>
          <button ${owned||!aff?'disabled':''}>${owned?'Equipped':'Buy'}</button>
        `;
        card.querySelector('button').onclick = async ()=>{
          state.gold -= i.cost;
          state.equipment[i.slot] = i.name;
          await saveState();
          document.getElementById('gold-count').textContent = state.gold;
          renderEquipment(); renderBuy();
        };
        grid.appendChild(card);
      });
    }

    function renderEquipment() {
      // for each equipment slot in state.equipment…
      for (let [slot, itemName] of Object.entries(state.equipment)) {
        // find the matching .slot.<slot> element
        let el = document.querySelector(`.slot.${slot}`);
        if (!el) continue;

        // if we have an item equipped, draw its icon + label…
        if (itemName) {
          el.innerHTML = `
            <img src="${ICON_PATH}${itemName.replace(/ /g,'_')}.png" onerror="this.style.opacity=0.5">
            <div class="slot-label">${itemName}</div>
          `;
        } else {
          // otherwise keep the default label
          let label = el.querySelector('.slot-label')?.textContent || slot;
          el.innerHTML = `<div class="slot-label">${label}</div>`;
        }
      }
    }

    function renderGrid(){
      document.getElementById('wc-level').textContent    = state.level;
      document.getElementById('wood-count').textContent  = state.wood;
      document.getElementById('wc-xp').textContent       = state.xp.toFixed(1);
      document.getElementById('wc-next').textContent     = state.level<MAX_LEVEL?nextXpFor(state.level).toFixed(1):'—';
      document.getElementById('player-hp').textContent   = state.health;
      document.getElementById('player-maxhp').textContent= state.maxHealth;

      let grid = document.getElementById('tree-grid'); grid.innerHTML = '';
      TREES.forEach(t=>{
        let card = document.createElement('div'); card.className='tree-card';
        card.innerHTML=`
          <img src="${t.img}" alt="${t.name}">
          <div class="label">${t.name} (Lv ${t.lvl})</div>
          <button ${state.level<t.lvl?'disabled':''}>Chop</button>
          ${state.level<t.lvl?`<div class="lock">Unlock at ${t.lvl}</div>`:''}
        `;
        let btn = card.querySelector('button');
        btn.onclick = async ()=> {
          if(state.inCombat) return;
          document.getElementById('chop-sound').currentTime=0;
          document.getElementById('chop-sound').play();
          document.getElementById('progress-text').textContent=`Chopping ${t.name}...`;
          let bar = document.getElementById('progress-bar');
          bar.style.transition='width .3s'; bar.style.width='100%';
          state.wood++; state.inventory[t.itemKey]++; state.xp+=t.xp;
          showNotif(`+1 ${t.itemKey} gathered!`); // <-- Add here
          while(state.level<MAX_LEVEL&&state.xp>=XP_TABLE[state.level+1]) state.level++;
          await saveState(); renderGrid();
          setTimeout(()=>{
            bar.style.transition='width 0s'; bar.style.width='0%';
            document.getElementById('progress-text').textContent='';
          },300);
        };
        grid.appendChild(card);
      });

      renderInventory();
    }

    function renderFiremakingGrid(){
      document.getElementById('fm-level').textContent = state.firemaking.level;
      document.getElementById('fire-count').textContent = state.firemaking.fires;
      document.getElementById('fm-xp').textContent = state.firemaking.xp.toFixed(1);
      document.getElementById('fm-next').textContent = state.firemaking.level<MAX_LEVEL?nextXpFor(state.firemaking.level).toFixed(1):'—';
      document.getElementById('gold-count-fm').textContent = state.gold;

      let grid = document.getElementById('fire-grid'); grid.innerHTML = '';
      FIRES.forEach(f=>{
        let card = document.createElement('div'); card.className='tree-card';
        card.innerHTML=`
          <img src="${f.img}" alt="${f.name}">
          <div class="label">${f.name} (Lv ${f.lvl})</div>
          <button ${state.firemaking.level<f.lvl?'disabled':''}>Light</button>
          ${state.firemaking.level<f.lvl?`<div class="lock">Unlock at ${f.lvl}</div>`:''}
        `;
        card.querySelector('button').onclick = async ()=>{
          document.getElementById('progress-text').textContent=`Lighting ${f.name}...`;
          let bar = document.getElementById('progress-bar');
          bar.style.transition='width .3s'; bar.style.width='100%';
          state.firemaking.fires++;
          state.firemaking.xp += f.xp;
          while(state.firemaking.level<MAX_LEVEL && state.firemaking.xp>=XP_TABLE[state.firemaking.level+1]) state.firemaking.level++;
          await saveState(); renderFiremakingGrid();
          setTimeout(()=>{
            bar.style.transition='width 0s'; bar.style.width='0%';
            document.getElementById('progress-text').textContent='';
          },300);
        };
        grid.appendChild(card);
      });
    }

    // — LEADERBOARD —
    async function refreshLeaderboard(){
      try{
        let r = await playfabCall('GetLeaderboard',{ StatisticName:'WoodcuttingScore', StartPosition:0, MaxResultsCount:5 });
        let list = document.getElementById('leader-list'); list.innerHTML='';
        r.Leaderboard.forEach(p=>{
          let li=document.createElement('li');
          li.textContent=`${p.Position+1}. ${p.DisplayName||p.PlayFabId} – ${p.StatValue}`;
          list.appendChild(li);
        });
      }catch{}
    }

    // — AUTO & CONTROLS —
    function getInterval(){ let min=2000,max=15000; return Math.min(max,min+(state.level-1)*(max-min)/(MAX_LEVEL-1)); }
    function animate(){ let pct=(Date.now()-(nextTick-interval))/interval; let bar=document.getElementById('progress-bar'); bar.style.transition='width 0s'; bar.style.width=`${Math.min(Math.max(pct,0),1)*100}%`; if(pct<1) requestAnimationFrame(animate); }
    async function autoTick(){ if(!autoEnabled) return; if(state.inCombat){ timer=setTimeout(autoTick,1000); return;} let t=TREES.filter(t=>state.level>=t.lvl).pop(); document.getElementById('progress-text').textContent=`Chopping ${t.name}...`; state.wood++; state.inventory[t.itemKey]++; state.xp+=t.xp/2;showNotif(`+1 ${t.itemKey} gathered!`); while(state.level<MAX_LEVEL&&state.xp>=XP_TABLE[state.level+1]) state.level++; await saveState(); renderGrid(); schedule(); setTimeout(()=>{ let bar=document.getElementById('progress-bar'); bar.style.transition='width 0s'; bar.style.width='0%'; document.getElementById('progress-text').textContent=''; },interval); }
    function schedule(){ clearTimeout(timer); if(!autoEnabled) return; interval=getInterval(); nextTick=Date.now()+interval; animate(); timer=setTimeout(autoTick,interval); }

    let stopBtn = document.getElementById('stop-btn'), resumeBtn = document.getElementById('resume-btn');
    stopBtn.onclick = ()=>{ autoEnabled=false; clearTimeout(timer); stopBtn.style.display='none'; resumeBtn.style.display=''; };
    resumeBtn.onclick = ()=>{ autoEnabled=true; resumeBtn.style.display='none'; stopBtn.style.display=''; schedule(); };
    resumeBtn.style.display='none';

    // — SHOP FILTERS & COLLAPSE —
    let shopPanel = document.getElementById('shop');
    shopPanel.querySelector('h3').onclick = () => shopPanel.classList.toggle('collapsed');
    shopPanel.querySelector('.shop-filters').onclick = e => {
      if(!e.target.matches('button[data-filter]')) return;
      shopPanel.querySelectorAll('.shop-filters button').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      let m = e.target.dataset.filter;

      document.getElementById('shop-grid').style.display = (m === 'buy') ? 'none' : '';
      document.getElementById('buy-grid').style.display  = (m === 'buy') ? '' : 'none';
      document.getElementById('buy-header').style.display = (m === 'buy') ? '' : 'none'; // <-- THIS LINE
    };

    // — INITIALIZE —
    async function initGame(){
      await loadState();
      document.getElementById('gold-count').textContent = state.gold;
      renderGrid();
      renderShop();
      renderBuy();
      renderEquipment();
      refreshLeaderboard();
      schedule();
    }

    document.querySelectorAll('.skill-list li').forEach(skill => {
    skill.onclick = () => {
      document.querySelectorAll('.skill-list li').forEach(li => li.classList.remove('active'));
      skill.classList.add('active');
      let skillName = skill.getAttribute('data-skill');
      document.getElementById('woodcutting-header').style.display = skillName==='woodcutting'?'':'none';
      document.getElementById('tree-grid').style.display = skillName==='woodcutting'?'':'none';
      document.getElementById('firemaking-header').style.display  = skillName==='firemaking'?'flex':'none';
      if(skillName==='woodcutting') renderGrid();
      if(skillName==='firemaking') renderFiremakingUI();
    };
    });
  </script>
 <script type="module">
  // —— Fishing module integrated with global state & persistence ——
  // Ensure the main `state` object holds inventory & fishing
  state.inventory = state.inventory || {};
  state.fishing   = state.fishing   || { lvl: 1, xp: 0, cnt: 0 };
  const fishState = state.fishing;

  // XP table
  const XP = (() => {
    const maxLevel = 99;
    const table = new Array(maxLevel + 2).fill(0);
    for (let lvl = 1; lvl <= maxLevel; lvl++) {
      let sum = 0;
      for (let i = 1; i <= lvl; i++) {
        sum += Math.floor(i + 300 * Math.pow(2, i / 7));
      }
      table[lvl] = Math.floor(sum / 4);
    }
    return table;
  })();
  const MAX = XP.length - 2;

  // Fish definitions
  const FISH = [
    { lvl: 1,  name: 'Shrimp',    img: 'Fish_Shrimp.png',    xp: 10  },
    { lvl: 5,  name: 'Anchovy',   img: 'Fish_Anchovy.png',   xp: 15  },
    { lvl: 30, name: 'Salmon',    img: 'Fish_Salmon.png',    xp: 50  },
    { lvl: 40, name: 'Trout',     img: 'Fish_Trout.png',     xp: 65  },
    { lvl: 60, name: 'Tuna',      img: 'Fish_Tuna.png',      xp: 85  },
    { lvl: 80, name: 'Lobster',   img: 'Fish_Lobster.png',   xp: 120 },
    { lvl: 90, name: 'Swordfish', img: 'Fish_Swordfish.png', xp: 150 },
    { lvl: 95, name: 'Shark',     img: 'Fish_Shark.png',     xp: 200 },
    { lvl: 99, name: 'Leviathan', img: 'Fish_Leviathan.png', xp: 300 }
  ];

  // DOM IDs
  const IDS = {
    level: 'fish-level', count: 'fish-count', xp: 'fish-xp', next: 'fish-next',
    bar: 'fish-progress-bar', text: 'fish-progress-text', grid: 'fish-grid',
    start: 'fish-start', stop: 'fish-stop'
  };

  // Cache UI
  const ui = {};
  function cacheUI() {
    for (let k in IDS) ui[k] = document.getElementById(IDS[k]);
  }

  function nextXp(lvl) {
    return lvl < MAX ? XP[lvl + 1] - XP[lvl] : Infinity;
  }

  // Render grid & stats
  function renderFishing() {
    ui.level.textContent = fishState.lvl;
    ui.count.textContent = fishState.cnt;
    ui.xp.textContent    = fishState.xp.toFixed(1);
    ui.next.textContent  = fishState.lvl < MAX ? nextXp(fishState.lvl).toFixed(1) : '—';

    ui.grid.innerHTML = '';
    FISH.forEach(f => {
      const unlocked = fishState.lvl >= f.lvl;
      const card = document.createElement('div'); card.className = 'item-card';
      card.innerHTML = `
        <img src="icons/fishing/${f.img}" onerror="this.src='icons/placeholder.png'">
        <div class="label">${f.name} (Lv ${f.lvl})</div>
        <button ${!unlocked?'disabled':''}>Fish</button>
        ${!unlocked?`<div class="lock">Unlock at ${f.lvl}</div>`:''}
      `;
      card.querySelector('button').addEventListener('click', () => catchFish(f));
      ui.grid.appendChild(card);
    });
  }

  // Animate bar
  function updateBar(dur = .3) {
    ui.bar.style.transition = `width ${dur}s`;
    ui.bar.style.width      = '100%';
  }
  function resetBar() {
    ui.bar.addEventListener('transitionend', function handler() {
      ui.bar.style.transition = '';
      ui.bar.style.width      = '0%';
      ui.text.textContent     = '';
      ui.bar.removeEventListener('transitionend', handler);
    });
  }

  // Single catch
  function catchFish(fish) {
    fishState.cnt++;
    fishState.xp  += fish.xp;
    // Add to shared inventory
    state.inventory[fish.name] = (state.inventory[fish.name] || 0) + 1;

    // Level up
    while (fishState.lvl < MAX && fishState.xp >= nextXp(fishState.lvl)) {
      fishState.xp  -= nextXp(fishState.lvl);
      fishState.lvl++;
    }
    if (fishState.lvl >= MAX) fishState.xp = 0;

    ui.text.textContent = `Fishing ${fish.name}…`;
    updateBar(); renderFishing(); resetBar();
    saveState(); renderInventory();
  }

  // Auto fishing
  let autoTimer = null, isRunning = false;
  function computeInterval() {
    const min = 2000, max = 15000;
    return min + (fishState.lvl - 1) * (max - min) / (MAX - 1);
  }
  function autoTick() {
    if (!isRunning) return;
    const avail = FISH.filter(f => fishState.lvl >= f.lvl);
    catchFish(avail[avail.length - 1]);
    autoTimer = setTimeout(autoTick, computeInterval());
  }

  // Controls
  function initFishing() {
    cacheUI();
    ui.start.addEventListener('click', () => { if (!isRunning) { isRunning = true; autoTick(); }});
    ui.stop .addEventListener('click', () => { isRunning = false; clearTimeout(autoTimer); });
    renderFishing();
  }

  // Tab switching
  window.addEventListener('DOMContentLoaded', () => {
    initFishing();
    const tabs      = document.querySelectorAll('.skill-list li');
    const fishPanel = document.getElementById('fishing-panel');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        fishPanel.style.display = (tab.dataset.skill === 'fishing') ? '' : 'none';
        if (tab.dataset.skill === 'fishing') renderFishing();
      });
    });
  });
</script>
<script src="firemaking.js"></script>
</body>
</html>